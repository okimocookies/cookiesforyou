<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookies For You</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Caveat:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FCFDE2;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .font-handwriting {
            font-family: 'Caveat', cursive;
        }
        .spotify-embed {
            border-radius: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .cookie-box.selected {
            border-color: #4C956C;
            box-shadow: 0 0 0 3px rgba(76, 149, 108, 0.5);
        }
        .message-card {
            position: relative;
            overflow: hidden;
            background-color: #2C6E49;
            color: white;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .message-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .message-card::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #4C956C;
            right: -100px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .message-card-cookie-img {
            position: absolute;
            width: 180px;
            height: 180px;
            right: -90px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }
        .message-content {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="w-full flex flex-col min-h-screen">
        <!-- Header -->
        <header class="p-4 md:p-6 max-w-6xl mx-auto w-full">
            <div class="flex justify-between items-center">
                <a href="/" id="logo" class="flex items-center gap-2 font-bold text-lg tracking-tighter text-[#2C6E49]">
                    <img src="/assets/logo.png" alt="Okimo Cookies Logo" class="h-8 w-auto">
                    <span class="font-handwriting text-3xl">cookiesforyou</span>
                </a>
                <nav class="hidden md:flex items-center space-x-6 text-sm font-medium text-gray-600">
                    <a href="#" id="submit-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">Submit</a>
                    <a href="?page=browse" id="browse-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">Browse</a>
                    <a href="?page=history" id="history-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">History</a>
                </nav>
                <!-- Mobile Burger Menu Button -->
                <div class="md:hidden">
                    <button id="burger-btn" class="p-2 rounded-md hover:bg-gray-200/50 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Mobile Menu Overlay -->
        <div id="mobile-menu" class="hidden fixed inset-0 bg-[#FCFDE2] z-50 p-4">
            <div class="flex justify-end mb-8">
                 <button id="close-mobile-menu-btn" class="p-2 rounded-md hover:bg-gray-200/50 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav class="flex flex-col items-center justify-center space-y-8 text-xl font-medium text-gray-600">
                <a href="#" id="submit-mobile-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">Submit</a>
                <a href="?page=browse" id="browse-mobile-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">Browse</a>
                <a href="?page=history" id="history-mobile-nav-btn" class="hover:text-[#2C6E49] cursor-pointer">History</a>
            </nav>
        </div>


        <main class="px-4 md:px-6 max-w-6xl mx-auto w-full flex-grow">
            <!-- Loading Spinner -->
            <div id="loading" class="text-center hidden py-20">
                <svg class="animate-spin h-8 w-8 text-gray-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-500">Memuat...</p>
            </div>

            <!-- Home View (Hero + Grid) -->
            <div id="home-view" class="space-y-12 hidden">
                <section class="text-center py-12 md:py-20">
                    <h1 class="text-4xl md:text-6xl font-handwriting tracking-tight text-[#2C6E49]">A bunch of the untold words,</h1>
                    <h2 class="text-4xl md:text-6xl font-handwriting tracking-tight" style="color: #4C956C;">sweetened with cookies & songs</h2>
                    <p class="mt-6 max-w-2xl mx-auto text-gray-500">Express your untold feelings with Okimo Cookies and music.</p>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="tell-story-btn" class="bg-[#2C6E49] text-white font-semibold py-3 px-8 rounded-lg hover:bg-[#4C956C] transition w-full sm:w-auto">Tell Your Story</button>
                        <a href="?page=browse" id="browse-stories-btn" class="font-semibold py-3 px-8 rounded-lg border border-gray-300 hover:bg-gray-100 transition w-full sm:w-auto">Browse the Stories</a>
                    </div>
                </section>
                
                <section id="message-grid-section">
                    <h3 class="text-2xl font-bold text-center text-[#2C6E49] mb-8">Latest Stories</h3>
                    <div id="message-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                </section>
            </div>

            <!-- Browse/History View -->
            <div id="grid-view" class="hidden max-w-6xl mx-auto py-12 space-y-8">
                <h1 id="grid-view-title" class="text-3xl font-bold text-center text-[#2C6E49]"></h1>
                <p id="grid-view-subtitle" class="text-center text-gray-600"></p>
                <div class="mb-8 max-w-xl mx-auto">
                    <input type="text" id="name-search" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-[#4C956C] focus:outline-none transition" placeholder="Cari berdasarkan nama penerima...">
                </div>
                <section id="full-grid-section">
                    <div id="full-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                </section>
            </div>


<!-- View Message View -->
            <div id="view-message" class="hidden justify-center items-center py-12">
                 <div class="w-full max-w-sm mx-auto">
                    <div id="view-card" class="bg-[#2C6E49] rounded-2xl shadow-2xl p-6 text-white relative overflow-hidden flex flex-col">
                        <div class="text-center space-y-4 flex-grow flex flex-col justify-center px-2 mt-2">
                            <div id="view-recipient-container"></div>
                        </div>
                        <div class="flex-shrink-0 flex justify-center mb-4">
                            <img src="/assets/logo-white.png" alt="Okimo Cookies Logo" class="h-8 w-auto">
                        </div>
<div class="relative h-1/3 flex-shrink-0">
                            <a id="view-cookie-link" href="#" target="_blank" rel="noopener noreferrer" class="relative block w-44 h-44 mx-auto">
                                <!-- Lingkaran Hijau Latar Belakang -->
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="w-40 h-40 bg-[#4C956C] rounded-full"></div>
                                </div>
                                <!-- Gambar Cookie -->
                                <img id="view-cookie-img" href="#" src="" alt="" class="absolute inset-0 w-full h-full object-cover rounded-full">
                            </a>
                        </div>
                        <div class="text-center space-y-4 flex-grow flex flex-col justify-center px-2 mt-2">
                       <p id="view-cookie-name" class="text-center font-semibold tracking-wider uppercase text-base sm:text-lg md:text-xl mt-1"></p>
                            <div id="view-recipient-container"></div>
                            <p id="view-message-text" class="font-handwriting text-4xl leading-tight flex-grow"></p>
                        </div>
                        <div id="spotify-player-container" class="mt-6 flex-shrink-0"></div>
                        <button id="share-btn" class="bg-[#FEFEE3] text-gray-800 font-bold py-3 px-10 rounded-lg hover:bg-gray-200 transition mt-6 flex-shrink-0 self-center">
                            Share
                        </button>
                    </div>
                    <button id="back-to-home-btn" class="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Kembali
                    </button>
                 </div>
            </div>
            
        <!-- Create Message Modal -->
        <div id="create-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-xl transform scale-95 custom-scrollbar overflow-y-auto max-h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-[#2C6E49]">Tell Your Story</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-800">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="recipient-name" class="block text-sm font-medium text-gray-600 mb-1">Untuk:</label>
                        <input type="text" id="recipient-name" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#4C956C] focus:outline-none transition" placeholder="Tulis nama, inisial, atau panggilan">
                    </div>
                    <div>
                        <label for="message-text" class="block text-sm font-medium text-gray-600 mb-1">Pesanmu:</label>
                        <textarea id="message-text" rows="4" maxlength="250" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#4C956C] focus:outline-none transition" placeholder="Tulis pesan anonim di sini..."></textarea>
                        <div id="char-counter" class="text-right text-sm text-gray-500 mt-1">0 / 250</div>
                    </div>
                    <div>
                        <label for="song-search" class="block text-sm font-medium text-gray-600 mb-1">Tempelkan Lagu:</label>
                        <input type="text" id="song-search" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#4C956C] focus:outline-none transition" placeholder="Cari judul lagu di Spotify...">
                        <div id="song-results" class="mt-2 max-h-40 overflow-y-auto space-y-2 custom-scrollbar"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Pilih Cookies:</label>
                        <div id="cookie-options" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <button id="create-btn" class="w-full bg-[#2C6E49] hover:bg-[#4C956C] text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg mt-2">
                        Kirim Pesan
                    </button>
                </div>
            </div>
        </div>
        
        <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

        <footer class="p-4 md:p-6 max-w-6xl mx-auto w-full mt-12">
            <div class="text-center text-gray-500">
                <a href="https://instagram.com/okimo.cookies" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 hover:text-[#2C6E49] transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-instagram" viewBox="0 0 16 16">
                        <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.917 3.917 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.703.01 5.556 0 5.829 0 8s.01 2.444.048 3.297c.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.556 15.99 5.829 16 8 16s2.444-.01 3.297-.048c.852-.04 1.433-.174 1.942-.372.526-.205.972-.478 1.417-.923.445-.444.718-.891.923-1.417.198-.51.333-1.09.372-1.942C15.99 10.444 16 10.171 16 8s-.01-2.444-.048-3.297c-.04-.852-.174-1.433-.372-1.942a3.916 3.916 0 0 0-.923-1.417A3.916 3.916 0 0 0 13.24.42c-.51-.198-1.092-.333-1.942-.372C10.444.01 10.171 0 8 0zm0 1.44c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.282.24.705.275 1.486.039.843.047 1.096.047 3.232s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.486a2.47 2.47 0 0 1-.599.92c-.28.28-.546.453-.92.598-.282.11-.705.24-1.486.275-.843.038-1.096.047-3.232.047s-2.389-.009-3.232-.047c-.78-.036-1.203-.166-1.486-.275a2.47 2.47 0 0 1-.92-.599 2.47 2.47 0 0 1-.598-.92c-.11-.282-.24-.705-.275-1.486-.038-.843-.046-1.096-.046-3.232s.008-2.389.046-3.232c.036-.78.166-1.204.275-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.486-.275.843-.038 1.096-.047 3.232-.047z"/>
                        <path d="M8 4.868a3.132 3.132 0 1 0 0 6.264 3.132 3.132 0 0 0 0-6.264zM8 6.31a1.69 1.69 0 1 1 0 3.38 1.69 1.69 0 0 1 0-3.38z"/>
                        <path d="M12.5 3.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                    </svg>
                    <span>okimo.cookies</span>
                </a>
            </div>
        </footer>
    </div>

    <script type="module">
        const loadingEl = document.getElementById('loading');
        const homeViewEl = document.getElementById('home-view');
        const gridViewEl = document.getElementById('grid-view');
        const viewMessageEl = document.getElementById('view-message');
        const createModalEl = document.getElementById('create-modal');
        const modalContentEl = createModalEl.querySelector('.modal-content');
        
        const recipientNameInput = document.getElementById('recipient-name');
        const messageTextInput = document.getElementById('message-text');
        const charCounter = document.getElementById('char-counter');
        const songSearchInput = document.getElementById('song-search');
        const songResultsEl = document.getElementById('song-results');
        const cookieOptionsEl = document.getElementById('cookie-options');
        const createBtn = document.getElementById('create-btn');
        const messageGridEl = document.getElementById('message-grid');
        const fullGridEl = document.getElementById('full-grid');
        const nameSearchInput = document.getElementById('name-search');
        
        const gridViewTitle = document.getElementById('grid-view-title');
        const gridViewSubtitle = document.getElementById('grid-view-subtitle');
        
        const viewRecipientName = document.getElementById('view-recipient-name');
        const viewMessageText = document.getElementById('view-message-text');
        const viewCookieImg = document.getElementById('view-cookie-img');
        const viewCookieName = document.getElementById('view-cookie-name');
        const viewCookieLink = document.getElementById('view-cookie-link');
        const spotifyPlayerContainer = document.getElementById('spotify-player-container');
        const shareBtn = document.getElementById('share-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const toastEl = document.getElementById('toast');
        const tellStoryBtn = document.getElementById('tell-story-btn');
        const browseStoriesBtn = document.getElementById('browse-stories-btn');
        const submitNavBtn = document.getElementById('submit-nav-btn');
        const browseNavBtn = document.getElementById('browse-nav-btn');
        const historyNavBtn = document.getElementById('history-nav-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const logoBtn = document.getElementById('logo');
        const burgerBtn = document.getElementById('burger-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuBtn = document.getElementById('close-mobile-menu-btn');
        const submitMobileNavBtn = document.getElementById('submit-mobile-nav-btn');
        const browseMobileNavBtn = document.getElementById('browse-mobile-nav-btn');
        const historyMobileNavBtn = document.getElementById('history-mobile-nav-btn');
        const viewRecipientContainer = document.getElementById('view-recipient-container');


        const cookieData = [
            { id: 'orijinaru', name: 'Classic Orijinaru', img: 'https://iili.io/FL2dlun.png' },
            { id: 'chokoreto', name: 'Rich Chokorēto', img: 'https://iili.io/FL2dYvt.png' },
            { id: 'matcha', name: 'Pure Matcha', img: 'https://iili.io/FL2d53N.png' },
            { id: 'redoberu', name: 'Sweet Redoberu', img: 'https://iili.io/FL2dayX.png' }
        ];

        let selectedSong = null;
        let selectedCookieId = 'orijinaru';
        let allMessagesCache = [];

        const searchSpotify = async (query) => {
            if (!query) { songResultsEl.innerHTML = ''; return; }
            songResultsEl.innerHTML = `<p class="text-gray-500 text-sm p-2">Mencari...</p>`;
            try {
                const response = await fetch(`/api/searchSpotify?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                displaySearchResults(data.tracks.items);
            } catch (error) {
                console.error("Error fetching from Spotify API:", error);
                songResultsEl.innerHTML = `<p class="text-red-500 text-sm p-2">Gagal mencari lagu. Pastikan backend berjalan.</p>`;
            }
        };

        const displaySearchResults = (tracks) => {
            songResultsEl.innerHTML = '';
            if (!tracks || tracks.length === 0) {
                songResultsEl.innerHTML = `<p class="text-gray-500 text-sm p-2">Lagu tidak ditemukan.</p>`;
                return;
            }
            tracks.forEach(track => {
                const trackEl = document.createElement('div');
                trackEl.className = 'p-2 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition flex items-center space-x-3';
                const artistNames = track.artists.map(artist => artist.name).join(', ');
                trackEl.innerHTML = `
                    <img src="${track.album.images[2]?.url || ''}" class="w-10 h-10 rounded-sm flex-shrink-0">
                    <div class="flex-grow overflow-hidden">
                        <p class="font-semibold truncate">${track.name}</p>
                        <p class="text-sm text-gray-500 truncate">${artistNames}</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-spotify text-green-500 flex-shrink-0" viewBox="0 0 16 16">
                      <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.669 11.538a.498.498 0 0 1-.686.165c-1.879-1.147-4.243-1.407-7.028-.77a.499.499 0 0 1-.222-.973c3.048-.696 5.662-.397 7.77.892a.5.5 0 0 1 .166.686zm.979-2.178a.624.624 0 0 1-.858.205c-2.15-1.321-5.428-1.704-7.972-.932a.625.625 0 0 1-.278-1.223c2.982-.878 6.59.102 8.986 1.54a.624.624 0 0 1 .206.858zm.083-2.29a.75.75 0 0 1-1.026.284c-2.433-1.463-6.52-1.77-9.088-.958a.75.75 0 0 1-.342-1.457c2.913-.881 7.425-.522 10.247 1.187a.75.75 0 0 1 .283 1.026z"/>
                    </svg>
                `;
                trackEl.onclick = () => selectSong(track);
                songResultsEl.appendChild(trackEl);
            });
        };
        
        const selectSong = (track) => {
            const artistNames = track.artists.map(artist => artist.name).join(', ');
            selectedSong = {
                id: track.id, name: track.name, artist: artistNames, image: track.album.images[2]?.url || ''
            };
            songSearchInput.value = `${track.name} - ${artistNames}`;
            songSearchInput.classList.add('bg-green-50', 'text-green-800', 'border-green-400');
            songResultsEl.innerHTML = '';
        };
        
        const renderCookieOptions = () => {
            cookieOptionsEl.innerHTML = '';
            cookieData.forEach(cookie => {
                const cookieBox = document.createElement('div');
                cookieBox.className = 'cookie-box border-2 border-gray-200 rounded-lg p-2 text-center cursor-pointer transition';
                cookieBox.dataset.cookieId = cookie.id;
                cookieBox.innerHTML = `
                    <img src="${cookie.img}" alt="${cookie.name}" class="w-full h-24 object-cover rounded-md mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/150x100/FCFDE2/2C6E49?text=Image+Not+Found';">
                    <p class="mt-2 text-sm font-semibold">${cookie.name}</p>`;
                cookieBox.addEventListener('click', () => {
                    selectCookie(cookie.id);
                });
                cookieOptionsEl.appendChild(cookieBox);
            });
        };

        const selectCookie = (cookieId) => {
            selectedCookieId = cookieId;
            document.querySelectorAll('.cookie-box').forEach(box => box.classList.remove('selected'));
            document.querySelector(`.cookie-box[data-cookie-id="${cookieId}"]`).classList.add('selected');
        };

        const showToast = (message, status = 'success') => {
            toastEl.textContent = message;
            toastEl.classList.remove('bg-green-500', 'bg-red-500');
            toastEl.classList.add(status === 'success' ? 'bg-green-500' : 'bg-red-500');
            toastEl.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { toastEl.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        };
        
        const showView = (viewName) => {
            loadingEl.classList.add('hidden');
            homeViewEl.classList.add('hidden');
            gridViewEl.classList.add('hidden');
            viewMessageEl.classList.remove('flex');
            viewMessageEl.classList.add('hidden');
            
            if (viewName === 'home') homeViewEl.classList.remove('hidden');
            else if (viewName === 'grid') gridViewEl.classList.remove('hidden');
            else if (viewName === 'view') {
                viewMessageEl.classList.remove('hidden');
                viewMessageEl.classList.add('flex');
            }
            else if (viewName === 'loading') loadingEl.classList.remove('hidden');
        };

        const openCreateModal = () => {
            createModalEl.classList.remove('hidden');
            setTimeout(() => {
                createModalEl.classList.remove('opacity-0');
                modalContentEl.classList.remove('scale-95');
            }, 10);
        };

        const closeCreateModal = () => {
            createModalEl.classList.add('opacity-0');
            modalContentEl.classList.add('scale-95');
            setTimeout(() => { createModalEl.classList.add('hidden'); }, 300);
        };

        const resetForm = () => {
            recipientNameInput.value = '';
            messageTextInput.value = '';
            charCounter.textContent = '0 / 250';
            songSearchInput.value = '';
            songSearchInput.classList.remove('bg-green-50', 'text-green-800', 'border-green-400');
            songResultsEl.innerHTML = '';
            selectedSong = null;
            selectCookie('orijinaru');
        };

const populateViewMessage = (data) => {
            const cookie = cookieData.find(c => c.id === data.cookie_id) || cookieData[0];
            viewCookieImg.src = cookie.img;
            viewCookieImg.alt = cookie.name;
            viewCookieName.textContent = cookie.name;
            viewCookieLink.href = 'https://shopee.co.id/Soft-Baked-Cookies-Premium-Hampers-Gift-by-Okimo-Cookies-(order-min.-2-pcs)-Beli-4-Lebih-Hemat-i.1483970996.26778195387';
            
            viewRecipientContainer.innerHTML = `
                <span class="block text-sm uppercase tracking-wider">UNTUK:</span>
                <span class="block text-3xl font-bold">${data.to}</span>
            `;
            
            if (data.song_id) {
                const iframe = document.createElement('iframe');
                iframe.className = 'spotify-embed';
                iframe.style = "width:100%; height:80px;";
                iframe.src = `https://open.spotify.com/embed/track/${data.song_id}`;
                iframe.setAttribute('frameBorder', '0');
                iframe.setAttribute('allowtransparency', 'true');
                iframe.setAttribute('allow', 'encrypted-media');
                spotifyPlayerContainer.innerHTML = '';
                spotifyPlayerContainer.appendChild(iframe);
            } else {
                 spotifyPlayerContainer.innerHTML = '';
            }
            
            const messageTextEl = document.getElementById('view-message-text');
            messageTextEl.textContent = data.message;
            
            // Logika penyesuaian font otomatis
            messageTextEl.classList.remove('text-4xl', 'text-3xl', 'text-2xl', 'text-xl');
            const len = data.message.length;
            if (len > 150) {
                messageTextEl.classList.add('text-2xl');
            } else if (len > 80) {
                messageTextEl.classList.add('text-3xl');
            } else {
                messageTextEl.classList.add('text-4xl');
            }

            showView('view');
        };

        const handleCreateMessage = async () => {
            const recipient = recipientNameInput.value.trim();
            const message = messageTextInput.value.trim();
            if (!recipient || !message) { 
                showToast('Nama dan pesan tidak boleh kosong.', 'error');
                return; 
            }
            
            createBtn.disabled = true;
            createBtn.innerHTML = 'Mengirim...';

            try {
                const response = await fetch('/api/saveMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: recipient, message: message, songId: selectedSong ? selectedSong.id : null,
                        cookieId: selectedCookieId, songInfo: selectedSong
                    })
                });
                if (!response.ok) throw new Error('Failed to save message');
                const result = await response.json();

                const history = JSON.parse(localStorage.getItem('messageHistory') || '[]');
                history.unshift(result.id);
                localStorage.setItem('messageHistory', JSON.stringify(history));

                createBtn.innerHTML = `<svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;

                setTimeout(async () => {
                    closeCreateModal();
                    await loadAndDisplayMessages({ target: messageGridEl, limit: 6, forceRefresh: true });
                    showToast('Pesan berhasil dikirim!', 'success');
                    resetForm();
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'Kirim Pesan';
                }, 1500);

            } catch (e) {
                console.error("Error creating message:", e);
                showToast('Gagal menyimpan pesan. Coba lagi.', 'error');
                createBtn.disabled = false;
                createBtn.innerHTML = 'Kirim Pesan';
            }
        };
        
        const loadAndDisplayMessages = async ({ target, limit = 0, filter = '', source = 'all', forceRefresh = false }) => {
            target.innerHTML = '';
            let messagesToDisplay = [];

            try {
                if (source === 'all') {
                    if (allMessagesCache.length === 0 || forceRefresh) {
                        const response = await fetch('/api/getMessages');
                        if (!response.ok) throw new Error('Failed to fetch messages');
                        allMessagesCache = await response.json();
                    }
                    messagesToDisplay = allMessagesCache;
                } else if (source === 'history') {
                    const historyIds = JSON.parse(localStorage.getItem('messageHistory') || '[]');
                    if (historyIds.length === 0) {
                        target.innerHTML = '<p class="text-gray-500 text-center col-span-full">Anda belum pernah mengirim pesan dari perangkat ini.</p>';
                        return;
                    }
                    const messagePromises = historyIds.map(async (id) => {
                        const res = await fetch(`/api/getMessage?id=${id}`);
                        return res.ok ? res.json() : null;
                    });
                    messagesToDisplay = (await Promise.all(messagePromises)).filter(Boolean);
                }

                const filteredMessages = messagesToDisplay.filter(msg => 
                    msg.to.toLowerCase().includes(filter.toLowerCase())
                );
                
                const limitedMessages = limit > 0 ? filteredMessages.slice(0, limit) : filteredMessages;

                if (limitedMessages.length === 0) {
                    target.innerHTML = '<p class="text-gray-500 text-center col-span-full">Tidak ada pesan yang cocok.</p>';
                } else {
                    limitedMessages.forEach((msg, index) => renderMessageGridItem(msg, false, target, index * 100));
                }
            } catch (error) {
                console.error("Error fetching messages:", error);
                target.innerHTML = '<p class="text-red-500 text-center col-span-full">Gagal memuat pesan.</p>';
            }
        };

        const renderMessageGridItem = (message, prepend = false, targetGrid = messageGridEl, delay = 0) => {
            const messageCard = document.createElement('a');
            messageCard.href = `?id=${message.id}`;
            messageCard.className = 'message-card block h-48 rounded-2xl shadow-sm hover:shadow-md hover:-translate-y-1 transition-all duration-300 cursor-pointer';
            
            const songInfo = message.songInfo;
            const cookieInfo = cookieData.find(c => c.id === message.cookie_id) || cookieData[0];

            let truncatedMessage = message.message;
            if (truncatedMessage.length > 20) {
                truncatedMessage = truncatedMessage.substring(0, 20) + '...';
            }

            messageCard.innerHTML = `
                <div class="h-full flex flex-col justify-between p-6 w-2/3">
                    <div class="flex-grow flex items-center">
                        <div>
                            <p class="text-sm text-slate-200">Untuk: ${message.to}</p>
                            <p class="font-handwriting text-3xl text-white mt-2 message-content">${truncatedMessage}</p>
                        </div>
                    </div>
                    <div class="text-xs text-slate-300 truncate pr-2 pt-2">
                        ${songInfo ? `<p class="font-semibold">${songInfo.name}</p><p>${songInfo.artist}</p>` : ''}
                    </div>
                </div>
                <img src="${cookieInfo.img}" alt="${cookieInfo.name}" class="message-card-cookie-img" onerror="this.onerror=null;this.src='https://placehold.co/130x130/FCFDE2/2C6E49?text=:)';">
            `;
            
            if (prepend) {
                targetGrid.prepend(messageCard);
            } else {
                targetGrid.appendChild(messageCard);
            }

            setTimeout(() => {
                messageCard.classList.add('visible');
            }, delay);
        };

        const router = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const messageId = urlParams.get('id');
            const page = urlParams.get('page');

            if (messageId) {
                showView('loading');
                try {
                    const response = await fetch(`/api/getMessage?id=${messageId}`);
                    if (!response.ok) throw new Error('Message not found');
                    const message = await response.json();
                    populateViewMessage(message);
                } catch (error) {
                    alert("Pesan tidak ditemukan.");
                    window.location.href = window.location.pathname;
                }
            } else if (page === 'history') {
                showView('grid');
                gridViewTitle.textContent = 'Your Submission History';
                gridViewSubtitle.textContent = "Messages you've created on this device.";
                await loadAndDisplayMessages({ target: fullGridEl, source: 'history' });
            } else if (page === 'browse') {
                showView('grid');
                gridViewTitle.textContent = 'All Stories';
                gridViewSubtitle.textContent = 'Browse all messages sent by everyone.';
                await loadAndDisplayMessages({ target: fullGridEl });
            }
            else {
                showView('home');
                await loadAndDisplayMessages({ target: messageGridEl, limit: 6 });
            }
        };

        messageTextInput.addEventListener('input', () => {
            charCounter.textContent = `${messageTextInput.value.length} / 250`;
        });

        createBtn.addEventListener('click', handleCreateMessage);
        
        let searchTimeout;
        songSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { searchSpotify(songSearchInput.value.trim()); }, 300);
        });

        nameSearchInput.addEventListener('input', (e) => {
            const page = new URLSearchParams(window.location.search).get('page');
            if (page === 'browse') {
                loadAndDisplayMessages({ target: fullGridEl, filter: e.target.value });
            } else if (page === 'history') {
                loadAndDisplayMessages({ target: fullGridEl, filter: e.target.value, source: 'history' });
            }
        });
        
        const goHome = (e) => {
            e.preventDefault();
            window.location.href = window.location.pathname;
        };

        backToHomeBtn.addEventListener('click', goHome);
        logoBtn.addEventListener('click', goHome);
        
        const navigate = (pageUrl) => {
            const currentUrl = new URL(window.location.href);
            const targetUrl = new URL(pageUrl, window.location.origin);
            if (currentUrl.pathname === targetUrl.pathname && currentUrl.search === targetUrl.search) {
                window.location.reload();
            } else {
                window.location.href = pageUrl;
            }
        };

        browseNavBtn.addEventListener('click', (e) => { e.preventDefault(); navigate('?page=browse'); });
        historyNavBtn.addEventListener('click', (e) => { e.preventDefault(); navigate('?page=history'); });
        browseStoriesBtn.addEventListener('click', (e) => { e.preventDefault(); navigate('?page=browse'); });
        
        browseMobileNavBtn.addEventListener('click', (e) => { e.preventDefault(); navigate('?page=browse'); });
        historyMobileNavBtn.addEventListener('click', (e) => { e.preventDefault(); navigate('?page=history'); });


        shareBtn.addEventListener('click', () => {
            const linkToCopy = `${window.location.origin}${window.location.pathname}?id=${new URLSearchParams(window.location.search).get('id')}`;
            navigator.clipboard.writeText(linkToCopy).then(() => {
                showToast('Link berhasil disalin!', 'success');
            }, (err) => {
                console.error('Fallback: Oops, unable to copy', err);
                showToast('Gagal menyalin link.', 'error');
            });
        });
        
        const openMobileMenu = () => mobileMenu.classList.remove('hidden');
        const closeMobileMenu = () => mobileMenu.classList.add('hidden');

        tellStoryBtn.addEventListener('click', openCreateModal);
        submitNavBtn.addEventListener('click', openCreateModal);
        submitMobileNavBtn.addEventListener('click', () => {
            closeMobileMenu();
            openCreateModal();
        });

        burgerBtn.addEventListener('click', openMobileMenu);
        closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
        
        closeModalBtn.addEventListener('click', closeCreateModal);
        createModalEl.addEventListener('click', (e) => { if (e.target === createModalEl) closeCreateModal(); });

        window.addEventListener('popstate', router);

        const init = () => {
            showView('loading');
            renderCookieOptions();
            selectCookie('orijinaru');
            router();
        };

        init();
    </script>
</body>
</html>
